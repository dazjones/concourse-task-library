#!/bin/bash -xeu

# shellcheck disabled=SC1091

BUILD_DIR=${PWD}

function commit_bbl_state_dir {
  local root_dir
  root_dir="${BUILD_DIR}"
  commit_message="Update bbl state dir}"

  pushd "${root_dir}/env-repo/${BBL_STATE_DIR}"
    if [[ -n $(git status --porcelain) ]]; then
      set_git_config
      git add --all .
      git commit -m "${commit_message}"
    fi
  popd

  pushd "${root_dir}"
    shopt -s dotglob
    cp -R env-repo/* updated-env-repo/
  popd
}

function main() {
	cd concourse-tasks/cloudsql-setup/terraform/

	terraform init
	terraform apply -var "project=${GCP_PROJECT}" --auto-approve --state="${BUILD_DIR}/env-repo/${BBL_STATE_DIR}"
}

trap commit_bbl_state_dir EXIT

main
